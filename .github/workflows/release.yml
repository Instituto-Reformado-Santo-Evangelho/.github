name: ğŸš€ Release AutomÃ¡tico

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do release (ex: v1.2.0)'
        required: true
        default: 'v1.0.0'

jobs:
  create-release:
    name: ğŸ“¦ Criar Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Obter informaÃ§Ãµes da tag
      id: tag_info
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag_name=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          if [[ ${GITHUB_REF#refs/tags/} =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: ğŸ“‹ Gerar changelog
      id: changelog
      run: |
        echo "Gerando changelog para ${{ steps.tag_info.outputs.tag_name }}..."
        
        # Obter commits desde o Ãºltimo tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -n "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
        else
          COMMITS=$(git log --pretty=format:"- %s")
        fi
        
        # Criar changelog
        cat > changelog.md << EOF
        ## ğŸ“– Novo Testamento FamÃ­lia 35 - ${{ steps.tag_info.outputs.tag_name }}
        
        ### ğŸ“š Status dos Livros BÃ­blicos
        
        #### âœ… Completos
        - **Mateus** - TraduÃ§Ã£o e revisÃ£o completas
        - **Marcos** - TraduÃ§Ã£o e revisÃ£o completas  
        - **Lucas** - TraduÃ§Ã£o e revisÃ£o completas
        
        #### ğŸ”„ Em Desenvolvimento
        - **JoÃ£o** - Em andamento
        
        ### ğŸ”„ MudanÃ§as nesta versÃ£o
        
        $COMMITS
        
        ### ğŸ“¦ Como usar
        
        1. Baixe o arquivo \`F35.nt\` 
        2. Abra o TheWord
        3. VÃ¡ em **Ferramentas > Instalar novos mÃ³dulos**
        4. Selecione o arquivo baixado
        
        ### ğŸ™ DedicaÃ§Ã£o
        
        > *"Seca-se a erva, e cai a flor, porÃ©m a palavra de nosso Deus subsiste eternamente."*  
        > **IsaÃ­as 40:8**
        
        Esta traduÃ§Ã£o Ã© dedicada Ã  glÃ³ria de Deus e ao crescimento espiritual do Seu povo.
        
        ### ğŸ“– Sobre a TraduÃ§Ã£o
        
        Baseada no trabalho do **Dr. Wilbur Norman Pickering** e extraÃ­da do livro "O Soberano Criador JÃ¡ Falou, 3Â° EdiÃ§Ã£o".
        
        **FamÃ­lia 35**: Representa um grupo de manuscritos gregos que preservam o texto original do Novo Testamento com alta fidelidade.
        EOF
        
        # Escapar caracteres especiais para GitHub Actions
        CHANGELOG_CONTENT=$(cat changelog.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ Preparar arquivos para release
      run: |
        echo "ğŸ“¦ Preparando arquivos para distribuiÃ§Ã£o..."
        
        # Criar diretÃ³rio de release
        mkdir -p release
        
        # Copiar mÃ³dulo principal
        if [ -f "modules/bible/f35/F35.nt" ]; then
          cp "modules/bible/f35/F35.nt" release/
          echo "âœ… F35.nt - MÃ³dulo principal copiado"
        fi
        
        # Copiar mÃ³dulos individuais
        for book in Mt Mc Lc Jo; do
          if [ -f "modules/bible/f35/${book}.nt" ]; then
            cp "modules/bible/f35/${book}.nt" release/
            echo "âœ… ${book}.nt - MÃ³dulo individual copiado"
          fi
        done
        
        # Criar README para o release
        cat > release/README.txt << 'EOF'
        ========================================
        THEWORD - NOVO TESTAMENTO FAMÃLIA 35
        ========================================
        
        Instituto Reformado Santo Evangelho
        https://irse.com.br
        
        INSTALAÃ‡ÃƒO:
        -----------
        1. Abra o software TheWord
        2. VÃ¡ em "Ferramentas > Instalar novos mÃ³dulos"
        3. Selecione o arquivo F35.nt
        4. Siga as instruÃ§Ãµes na tela
        
        ARQUIVOS INCLUÃDOS:
        ------------------
        - F35.nt     : MÃ³dulo principal (todos os livros)
        - Mt.nt      : Evangelho de Mateus
        - Mc.nt      : Evangelho de Marcos  
        - Lc.nt      : Evangelho de Lucas
        - Jo.nt      : Evangelho de JoÃ£o (se disponÃ­vel)
        
        SOBRE A TRADUÃ‡ÃƒO:
        ----------------
        TraduÃ§Ã£o do Dr. Wilbur Norman Pickering
        Baseada na FamÃ­lia 35 de manuscritos gregos
        
        "Seca-se a erva, e cai a flor, porÃ©m 
         a palavra de nosso Deus subsiste eternamente."
        - IsaÃ­as 40:8
        
        Para mais informaÃ§Ãµes, visite:
        https://github.com/Instituto-Reformado-Santo-Evangelho/theword
        EOF
        
        # Listar arquivos preparados
        echo "ğŸ“‹ Arquivos preparados para release:"
        ls -la release/
        
    - name: ğŸš€ Criar release no GitHub
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_info.outputs.tag_name }}
        release_name: ğŸ“– TheWord F35 ${{ steps.tag_info.outputs.tag_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ steps.tag_info.outputs.is_prerelease }}
        
    - name: ğŸ“ Upload arquivos do release
      run: |
        echo "ğŸ“ Fazendo upload dos arquivos..."
        
        # Upload de cada arquivo na pasta release
        for file in release/*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "Uploading: $filename"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.create_release.outputs.id }}/assets?name=$filename"
          fi
        done
        
    - name: ğŸ‰ Release concluÃ­do
      run: |
        echo "ğŸ‰ RELEASE ${{ steps.tag_info.outputs.tag_name }} CRIADO COM SUCESSO!"
        echo "================================================"
        echo ""
        echo "ğŸ“– 'Toda Escritura Ã© inspirada por Deus e Ãºtil para o ensino,"
        echo "    para a repreensÃ£o, para a correÃ§Ã£o, para a educaÃ§Ã£o na"
        echo "    justiÃ§a' - 2 TimÃ³teo 3:16"
        echo ""
        echo "ğŸ™ Que este trabalho seja uma bÃªnÃ§Ã£o para o povo de Deus!"
        echo ""
        echo "ğŸ”— Release disponÃ­vel em:"
        echo "   ${{ steps.create_release.outputs.html_url }}"